<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20161219" />
    <meta http-equiv="Content-Language" content="en" />
    <title>EHRI Backend &#x2013; Example Ingest</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                        <img src="https://ehri-project.eu/sites/all/themes/ehri_new/images/logo.png"  alt="EHRI Backend"/>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2016-12-19
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.13.6-SNAPSHOT
                          <span class="divider">|</span>
                      </li>
                                      <li class="">
                    <a href="index.html" title="EHRI Backend">
        EHRI Backend</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Example Ingest</li>
                
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Developer Notes</li>
                              
      <li>
  
                          <a href="install.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                
      <li>
  
                          <a href="deployment.html" title="Deployment">
          <i class="none"></i>
        Deployment</a>
            </li>
                
      <li>
  
                          <a href="import.html" title="Importing Data">
          <i class="none"></i>
        Importing Data</a>
            </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>EAD Ingest</a>
          </li>
                
      <li>
  
                          <a href="gotchas.html" title="Gotchas">
          <i class="none"></i>
        Gotchas</a>
            </li>
                
      <li>
  
                          <a href="migrations.html" title="DB Migration History">
          <i class="none"></i>
        DB Migration History</a>
            </li>
                
      <li>
  
                          <a href="scripting.html" title="Scripting">
          <i class="none"></i>
        Scripting</a>
            </li>
                
      <li>
  
                          <a href="permissions.html" title="Permissions">
          <i class="none"></i>
        Permissions</a>
            </li>
                
      <li>
  
                          <a href="serialization.html" title="Data Serialization Config">
          <i class="none"></i>
        Data Serialization Config</a>
            </li>
                
      <li>
  
                          <a href="validation.html" title="Validation">
          <i class="none"></i>
        Validation</a>
            </li>
                
      <li>
  
                          <a href="identifiers.html" title="Identifiers">
          <i class="none"></i>
        Identifiers</a>
            </li>
                
      <li>
  
                          <a href="web-service.html" title="Web Service Usage">
          <i class="none"></i>
        Web Service Usage</a>
            </li>
                
      <li>
  
                          <a href="loaddump.html" title="Dumping and Loading JSON backups">
          <i class="none"></i>
        Dumping and Loading JSON backups</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="ehri-definitions/index.html" title="Data Definitions">
          <i class="none"></i>
        Data Definitions</a>
            </li>
                
      <li>
  
                          <a href="ehri-core/index.html" title="Core Java API">
          <i class="none"></i>
        Core Java API</a>
            </li>
                
      <li>
  
                          <a href="ehri-ws/index.html" title="Web Service">
          <i class="none"></i>
        Web Service</a>
            </li>
                
      <li>
  
                          <a href="ehri-io/index.html" title="Import Tools">
          <i class="none"></i>
        Import Tools</a>
            </li>
                
      <li>
  
                          <a href="ehri-cli/index.html" title="Command Line Utilities">
          <i class="none"></i>
        Command Line Utilities</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                            
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
                              <li class="nav-header">API Docs</li>
                              
      <li>
  
                          <a href="apidocs/index.html" title="Javadocs">
          <i class="none"></i>
        Javadocs</a>
            </li>
                              <li class="nav-header">Web Service Docs</li>
                              
      <li>
  
                          <a href="ehri-ws/wsdocs/index.html" title="Web API">
          <i class="none"></i>
        Web API</a>
            </li>
                                    
      <li>
  
                          <a href="samples.tgz" title="Import Data Samples">
          <i class="none"></i>
        Import Data Samples</a>
            </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Example Ingest</h1>
<p>The current ingest procedure is somewhat long-winded and technical. This is an example given a single EAD XML file containing a large number (48,000) of individual documentary unit items in a single fonds. The repository is the Internation Tracing Service (ITS), which has EHRI repository ID <tt>de-002409</tt>.</p>
<p>This ingest covers importing the EAD file into the staging server, at which time it should be ready for verification and if necessary, changes, before the production ingest.</p>
<div class="section">
<h2><a name="Before_you_start"></a>Before you start</h2>
<p>First, log into the EHRI staging server via SSH and open a bunch of shells. In one of them, tail the following file, which will give us some information about what goes wrong, when something inevitably goes wrong the first few times we try:</p>

<div class="source">
<div class="source">
<pre>tail -f /opt/webapps/neo4j-version/logs/log/neo4j.log
</pre></div></div>
<div class="section">
<h3><a name="Back_up_the_database"></a>Back up the database</h3>
<p>The Neo4j DB lives in /opt/webapps/data/neo4j/databases/graph.db. You can back it up without shutting down the server by running:</p>

<div class="source">
<div class="source">
<pre>/opt/webapps/neo4j-backup.sh graph.db.BAK
</pre></div></div>
<p>To restore the DB the procedure is:  - shut down Neo4j  - replace /opt/webapps/data/neo4j/databases/graph.db with backup directory you specified previously  - ensure all files in the graph.db directory are owned and writable by the <tt>webadm</tt> group:  - chgrp -R webadm graph.db  - chmod -R g+rw graph.db  - restart Neo4j</p></div></div>
<div class="section">
<h2><a name="Procedure"></a>Procedure</h2>
<p>Onwards with the ingest&#x2026;</p>
<p>Next, in another shell, copy the file(s) to be ingested to the server and place them in <tt>/opt/webapps/data/import-data/de/de-002409</tt>, the working directory for ITS data.</p>
<p>Import properties handle certain mappings between tags (with particular attributes) and EHRI fields. The ITS data has a particular mapping indicating that when the <tt>&lt;unitid&gt;</tt> has a <tt>type=&quot;refcode&quot;</tt> that is the main doc unit identifier, and that the rest are the alternates. This file is, in this case:</p>

<div class="source">
<div class="source">
<pre>/opt/webapps/data/import-data/de/de-002409/its-pertinence.properties
</pre></div></div>
<p>The actual import is done via the /ehri/import/ead endpoint on the Neo4j extension. It is documented here: <a class="externalLink" href="http://ehri.github.io/docs/api/ehri-rest/ehri-extension/wsdocs/resource_ImportResource.html">http://ehri.github.io/docs/api/ehri-rest/ehri-extension/wsdocs/resource_ImportResource.html</a></p>
<p>The basic procedure is:</p>

<ul>
  
<li>obtain an appropriate import properties file (which we&#x2019;ve done in this case)</li>
  
<li>write an appropriate log file, describing what we&#x2019;re doing</li>
  
<li>stick the EAD XML on the server</li>
  
<li>run a curl command, POSTing the XML data to the ingest endpoint, with  the appropriate parameters</li>
  
<li>re-index the data held by our repository (ITS, de-002409) to make it  searchable in the portal UI</li>
</ul>
<p>To make the curl command less cumbersome, lets export the path to the properties file as an environment variable:</p>

<div class="source">
<div class="source">
<pre>export PROPERTIES=/opt/webapps/data/import-data/de/de-002409/its-pertinence.properties
</pre></div></div>
<p>Also, lets write a log file and export it&#x2019;s path as an environment variable:</p>

<div class="source">
<div class="source">
<pre>echo &quot;Importing ITS data with properties: $PROPERTIES&quot; &gt; LOG.txt
export LOG=`pwd`/LOG.txt
</pre></div></div>
<p>Now we can POST the data to the ingest endpoint:</p>

<div class="source">
<div class="source">
<pre>curl -XPOST \
    -H &quot;X-User:mike&quot; \
    -H &quot;Content-type: text/xml&quot; \
    --data-binary @KHSK_GER.xml \
    &quot;http://localhost:7474/ehri/import/ead?scope=de-002409&amp;log=$LOG&amp;properties=$PROPERTIES&quot;
</pre></div></div>
<p>These parameters are:</p>

<ul>
  
<li>the <tt>X-User</tt> header tells the web service which user is responsible for the ingest</li>
  
<li>the <tt>Content-type</tt> header tells it to expect XML data</li>
  
<li>the <tt>scope=de-002409</tt> query parameter tells it we&#x2019;re importing this EAD into  the ITS repository</li>
  
<li>the <tt>log=$LOG</tt> parameter tells it to find the log text in a local file</li>
  
<li>the <tt>properties=$PROPERTIES</tt> parameter tells it to file the import properties  in a local file</li>
</ul>
<p><b>Note</b>: when importing a single EAD containing ~50,000 items in a single transaction the staging server might run out of memory. If it does the only option is to increase the Neo4j heap size by uncommenting and setting the <tt>dbms.memory.heap.max_size=MORE_MB</tt> (say,  3500) in <tt>$NEO4J_HOME/conf/neo4j-wrapper.conf</tt> and restarting Neo4j by running:</p>

<div class="source">
<div class="source">
<pre>sudo service neo4j-service restart
</pre></div></div>
<p><b>Additional note</b>: <i>Certain date patterns are fuzzy parsed by the importer and invalid dates such as 31st April will currently throw a runtime exception resulting in a BadRequest from the web service. So fix all these first</i> ;)</p>
<p>If all goes well you should get something like this:</p>

<div class="source">
<div class="source">
<pre>{&quot;created&quot;:48430,&quot;unchanged&quot;:0,&quot;message&quot;:&quot;Import ITS 0.4 data using its-pertinence.properties.\n&quot;,&quot;updated&quot;:0,&quot;errors&quot;:{}}
</pre></div></div>
<p>In theory, that ingest should be idemotent, so you can run the same command again and not change anything. Instead you&#x2019;d get a reply like:</p>

<div class="source">
<div class="source">
<pre>{&quot;created&quot;:0,&quot;unchanged&quot;:48430,&quot;message&quot;:&quot;Import ITS 0.4 data using its-pertinence.properties.\n&quot;,&quot;updated&quot;:0,&quot;errors&quot;:{}}
</pre></div></div></div>
<div class="section">
<h2><a name="Indexing"></a>Indexing</h2>
<p>The final step is the re-index the ITS repository, making the items searchable. This can be done from the Portal Admin UI, or via the following command:</p>

<div class="source">
<div class="source">
<pre>java -jar /opt/webapps/docview/bin/indexer.jar \
     --clear-key-value holderId=de-002409 \
     --index -H &quot;X-User=admin&quot; \
     --stats \
     --solr http://localhost:8080/ehri/portal \
     --rest http://localhost:7474/ehri \
     &quot;Repository|de-002409&quot;
</pre></div></div>
<p>(This tool is a library/CLI utility the is used by the portal UI and available on the server: see the <a class="externalLink" href="https://github.com/EHRI/ehri-search-tools">https://github.com/EHRI/ehri-search-tools</a> project for more details.)</p></div>
<div class="section">
<h2><a name="Updating_existing_collections"></a>Updating existing collections</h2>
<p>To update existing collections, when, for example, adding descriptions in another language, the procedure is exactly the same with one exception: the import Curl command needs an additional parameter:</p>

<div class="source">
<div class="source">
<pre>&amp;allow-update=true
</pre></div></div>
<p>Without this parameter the importer will throw a mode violation error when it ends up updating an existing collection.</p></div>
<div class="section">
<h2><a name="Ingesting_multiple_files_in_an_archive"></a>Ingesting multiple files in an archive</h2>
<p>It is possible to ingest multiple EAD files in a single transaction by providing the importer with an archive file (containing multiple XML files) instead of a single XML file. Currently the following formats are supported:</p>

<ul>
  
<li>zip (although some extensions are problematic)</li>
  
<li>tar</li>
  
<li>tar.gz</li>
</ul>
<p>The importer will assume the data it is given is an archive if the content type of the request is given as <tt>application/octet-stream</tt> (aka, miscellaneous binary) instead of either <tt>text/xml</tt> (XML) or <tt>text/plain</tt> (local file paths.)</p>
<p><b>Note</b>: if several EAD files provide different translations of the same items it is necessary to enable update ingests via <tt>&amp;allow-updates=true</tt>.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2016
                        <a href="http://ehri-project.eu">The European Holocaust Research Infrastructure (EHRI)</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
