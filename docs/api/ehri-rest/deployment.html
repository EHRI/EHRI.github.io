<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20151110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>EHRI Backend &#x2013; Deployment</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                        <img src="https://ehri-project.eu/sites/all/themes/ehri_new/images/logo.png"  alt="EHRI Backend"/>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-11-10
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 0.11.2-SNAPSHOT
                          <span class="divider">|</span>
                      </li>
                                      <li class="">
                    <a href="index.html" title="EHRI Backend">
        EHRI Backend</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Deployment</li>
                
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Developer Notes</li>
                              
      <li>
  
                          <a href="install.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>Deployment</a>
          </li>
                
      <li>
  
                          <a href="import.html" title="Importing Data">
          <i class="none"></i>
        Importing Data</a>
            </li>
                
      <li>
  
                          <a href="gotchas.html" title="Gotchas">
          <i class="none"></i>
        Gotchas</a>
            </li>
                
      <li>
  
                          <a href="migrations.html" title="DB Migration History">
          <i class="none"></i>
        DB Migration History</a>
            </li>
                
      <li>
  
                          <a href="scripting.html" title="Scripting">
          <i class="none"></i>
        Scripting</a>
            </li>
                
      <li>
  
                          <a href="permissions.html" title="Permissions">
          <i class="none"></i>
        Permissions</a>
            </li>
                
      <li>
  
                          <a href="serialization.html" title="Data Serialization Config">
          <i class="none"></i>
        Data Serialization Config</a>
            </li>
                
      <li>
  
                          <a href="validation.html" title="Validation">
          <i class="none"></i>
        Validation</a>
            </li>
                
      <li>
  
                          <a href="identifiers.html" title="Identifiers">
          <i class="none"></i>
        Identifiers</a>
            </li>
                
      <li>
  
                          <a href="web-service.html" title="Web Service Usage">
          <i class="none"></i>
        Web Service Usage</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="ehri-definitions/index.html" title="Data Definitions">
          <i class="none"></i>
        Data Definitions</a>
            </li>
                
      <li>
  
                          <a href="ehri-frames/index.html" title="Core Java API">
          <i class="none"></i>
        Core Java API</a>
            </li>
                
      <li>
  
                          <a href="ehri-extension/index.html" title="Web Service">
          <i class="none"></i>
        Web Service</a>
            </li>
                
      <li>
  
                          <a href="ehri-importers/index.html" title="Import Tools">
          <i class="none"></i>
        Import Tools</a>
            </li>
                
      <li>
  
                          <a href="ehri-cmdline/index.html" title="Command Line Utilities">
          <i class="none"></i>
        Command Line Utilities</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                            
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                        
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
                              <li class="nav-header">API Docs</li>
                              
      <li>
  
                          <a href="apidocs/index.html" title="Javadocs">
          <i class="none"></i>
        Javadocs</a>
            </li>
                              <li class="nav-header">Web Service Docs</li>
                              
      <li>
  
                          <a href="ehri-extension/wsdocs/index.html" title="Web API">
          <i class="none"></i>
        Web API</a>
            </li>
                                    
      <li>
  
                          <a href="samples.tgz" title="Import Data Samples">
          <i class="none"></i>
        Import Data Samples</a>
            </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Deployment</h1>
<p><b>This is a work in progress document.</b></p>
<p>The EHRI REST backend is deployed as a Neo4j unmanaged extension. In practice, this means:</p>

<ul>
  
<li>it compiles to a bunch of Jars which live in the <tt>plugins/ehri</tt> directory of a Neo4j installation</li>
  
<li>the following setting in <tt>neo4j-server.conf</tt> maps our Jersey web URIs to a path (/ehri):</li>
  
<li><tt>org.neo4j.server.thirdparty_jaxrs_classes=eu.ehri.extension=/ehri</tt></li>
</ul>
<p>In practice, a set of symlinks are used to allow easier versioning of releases:</p>
<p>The symlink <tt>$NEO4J_HOME/plugins/ehri</tt> points to <tt>/opt/webapps/ehri-rest/current</tt>, which is itself a symlink to <tt>/opt/webapps/ehri-rest/deploys/[TIMESTAMP]_[GIT-REV]</tt>.</p>
<p>When new versions of the EHRI code are released the Jars are uploaded to a directory in <tt>/opt/webapps/ehri-rest/deploys</tt> that is named with the timestamp and the code&#x2019;s git revision. Then the <tt>current</tt> symlink is updated to point to the new deployment and the Neo4j service restarted.</p>
<div class="section">
<h2><a name="Using_the_Fabfile_for_automated_deployment_tasks"></a>Using the Fabfile for automated deployment tasks</h2>
<p>The <tt>fabfile.py</tt> script provides a set of tasks that can be used to release new versions of the code. Once Fabric (version 1.8) has been installed (typically via <tt>sudo pip install fabric</tt>) you can view the available tasks like so:</p>

<div class="source">
<div class="source">
<pre>$&gt; fab --list

Fabric deployment script for EHRI rest backend.

Available commands:

    clean_deploy         Build a clean version and deploy.
    copy_db              Copy a (not running) DB from the remote server.
    current_version      Show the current date/revision
    current_version_log  Output git log between HEAD and the current deployed version.
    deploy               Deploy the latest version of the site to the servers, install any
    latest               Point symlink at latest version.
    online_backup        Do an online backup to a particular directory on the server.
    online_clone_db      Copy a Neo4j DB from a server using the backup tool.
    prod                 Use the remote virtual server.
    reindex_all          Run a full reindex of Neo4j -&gt; Solr data
    reindex_repository   Reindex items held by a repository.
    restart              Restart neo4j-service.
    rollback             Rollback to the last versioned dir and restart.
    stage                Use the remote staging server.
    start                Start neo4j-service.
    stop                 Stop neo4j-service.
    test                 Use the remote testing server.
    update_db            Update a Neo4j DB on a server.
</pre></div></div>
<p>More detailed info for tasks are available with the <tt>-d</tt> switch:</p>

<div class="source">
<div class="source">
<pre>$&gt; fab -d online_clone_db

Displaying detailed information for task 'online_clone_db':

    Copy a Neo4j DB from a server using the backup tool.
        This creates a copy of the running DB in /tmp, zips it,
        downloads the zip, extracts it to the specified DB, and
        cleans up.

        clone_db:/local/path/to/graph.db

    Arguments: local_dir
</pre></div></div>
<p>Three environments are available (which assume you have the hostnames defined in your .ssh/config file):</p>

<ul>
  
<li>test (sets hostname to <tt>ehritest</tt>)</li>
  
<li>stage (sets hostname to <tt>ehristage</tt>)</li>
  
<li>prod (sets hostname to <tt>ehriprod</tt>)</li>
</ul>
<p>You can activate these environments by running them as commands prior to another task, i.e.</p>

<div class="source">
<div class="source">
<pre>$&gt; fab stage deploy # runs the deploy task with the 'ehristage' server
</pre></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2015
                        <a href="http://ehri-project.eu">The European Holocaust Research Infrastructure (EHRI)</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
