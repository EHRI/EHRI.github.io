<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-10-07 
 | Rendered using Apache Maven Fluido Skin 1.3.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20141007" />
    <meta http-equiv="Content-Language" content="en" />
    <title>EHRI Backend &#x2013; Scripting the EHRI environment</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.1.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.1.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                        <img src="https://ehri-project.eu/sites/all/themes/ehri_new/images/logo.png"  alt="EHRI Backend"/>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-10-07
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 1.0
                          <span class="divider">|</span>
                      </li>
                                      <li class="">
                    <a href="index.html" title="EHRI Backend">
        EHRI Backend</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Scripting the EHRI environment</li>
                
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Developer Notes</li>
                              
      <li>
  
                          <a href="install.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                
      <li>
  
                          <a href="deployment.html" title="Deployment">
          <i class="none"></i>
        Deployment</a>
            </li>
                
      <li>
  
                          <a href="import.html" title="Importing Data">
          <i class="none"></i>
        Importing Data</a>
            </li>
                
      <li>
  
                          <a href="gotchas.html" title="Gotchas">
          <i class="none"></i>
        Gotchas</a>
            </li>
                
      <li>
  
                          <a href="migrations.html" title="DB Migration History">
          <i class="none"></i>
        DB Migration History</a>
            </li>
                
      <li class="active">
  
            <a href="#"><i class="none"></i>Scripting</a>
          </li>
                
      <li>
  
                          <a href="permissions.html" title="Permissions">
          <i class="none"></i>
        Permissions</a>
            </li>
                
      <li>
  
                          <a href="serialization.html" title="Data Serialization Config">
          <i class="none"></i>
        Data Serialization Config</a>
            </li>
                
      <li>
  
                          <a href="validation.html" title="Validation">
          <i class="none"></i>
        Validation</a>
            </li>
                
      <li>
  
                          <a href="identifiers.html" title="Identifiers">
          <i class="none"></i>
        Identifiers</a>
            </li>
                              <li class="nav-header">Modules</li>
                              
      <li>
  
                          <a href="ehri-definitions/index.html" title="Data Definitions">
          <i class="none"></i>
        Data Definitions</a>
            </li>
                
      <li>
  
                          <a href="ehri-frames/index.html" title="Core Java API">
          <i class="none"></i>
        Core Java API</a>
            </li>
                
      <li>
  
                          <a href="ehri-extension/index.html" title="Web Service">
          <i class="none"></i>
        Web Service</a>
            </li>
                
      <li>
  
                          <a href="ehri-importers/index.html" title="Import Tools">
          <i class="none"></i>
        Import Tools</a>
            </li>
                
      <li>
  
                          <a href="ehri-cmdline/index.html" title="Command Line Utilities">
          <i class="none"></i>
        Command Line Utilities</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                            
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                  
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
                              <li class="nav-header">API Docs</li>
                              
      <li>
  
                          <a href="apidocs/index.html" title="Javadocs">
          <i class="none"></i>
        Javadocs</a>
            </li>
                              <li class="nav-header">Web Service Docs</li>
                              
      <li>
  
                          <a href="ehri-extension/wsdocs/index.html" title="Web API">
          <i class="none"></i>
        Web API</a>
            </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Scripting the EHRI environment</h1>
<div class="section">
<h2><a name="Introduction"></a>Introduction</h2>
<p>While in the process of stabilising the server environment, it is useful to have some scripting tools at our disposal which are able to interact with the various Java tools we have, without requiring the writing and deployment of more Java code. This is particularly the case where one-off migrations of the graph data is required as its ontology evolves, or importing of WIP data acquisitions.</p>
<p>Another important consideration of a scripting environment was access to a REPL, which would allow us to investigate issues with the graph data interactively via a command-line prompt.</p>
<p>A few different environments have so far been investigated:</p>

<ul>
  
<li>Jython</li>
  
<li>Groovy</li>
  
<li>JRuby</li>
</ul>
<p>While these investigations have not been exhaustive, a few impressions resulted:</p>
<div class="section">
<h3><a name="Jython"></a>Jython</h3>
<p>The Java version of Python (2.7b1) works fine, but does not seem to have a very active development community, and it was difficult to find up-to-date information. One particular advantage of Python would potentially be access to IPython, which is a really good REPL with auto-complete and many other nice features, but as of this writing it does not seem to work with the Jython environment. Jython development also seems to lag the  standard C-Python development by quite a lot.</p></div>
<div class="section">
<h3><a name="Groovy"></a>Groovy</h3>
<p>Groovy is a language with very tight Java integration, but setting up a workable scripting environment that integrated the EHRI tools proved difficult. While some tools do use Groovy as a REPL environment, there seem to be quite a lot of hoops to jump through before this works smoothly. More work may follow on this&#x2026;</p></div>
<div class="section">
<h3><a name="JRuby"></a>JRuby</h3>
<p>JRuby proved easy to set up, up-to-date, and includes a workable (if not IPython-level) REPL environment (called <tt>jirb</tt>). One particular bonus of JRuby is that its creators have gone to great lengths to make Java integration as tight as possible, and moreover, make it easy to write idiomatic Ruby code that works with Java tools. What follows is mainly an overview of writing JRuby scripts to interact with the EHRI environment.</p></div></div>
<div class="section">
<h2><a name="Setting_up_JRuby"></a>Setting up JRuby</h2>
<p>As of this writing the current version of JRuby is 1.7.4. The distribution provides an installer and should work on Linux, Mac OS X, and Windows.</p>
<p>Once JRuby is installed it&#x2019;s useful to add it&#x2019;s <tt>bin</tt> directory to your <tt>$PATH</tt> environment var. Once done, you should be able to launch scripts with <tt>jruby script.rb</tt> and start the interactive prompt with <tt>jirb</tt>.</p></div>
<div class="section">
<h2><a name="JRuby_basics"></a>JRuby basics</h2>
<p>For the basics of how JRuby integrates with Java, the following document is essential reading:</p>
<p><a class="externalLink" href="https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby">https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby</a></p>
<p>The TL;DR is basically:</p>

<div class="source">
<div class="source">
<pre># The magic require Java line
require 'java'

# You can then refer to Java stuff as normal:
puts java.util.Locale.getDefault.getLanguage # prints &quot;en&quot; on my system

# Note: Jruby makes things look more idiomatic by converting automatically
# between CamelCase and the more Ruby-ish under_score naming, so this also
# works
puts java.util.Locale.get_default.get_language # also prints &quot;en&quot;!
</pre></div></div>
<p>To import stuff in a manner similar to how you would in Java, you can use the <tt>java_import</tt> statement:</p>

<div class="source">
<div class="source">
<pre>java_import &quot;eu.ehri.project.models.UserProfile&quot;
</pre></div></div>
<p>(The quotes are necessary if the root package is outside of the Java environemt.)</p></div>
<div class="section">
<h2><a name="Integration_with_the_EHRI_environment"></a>Integration with the EHRI environment</h2>
<div class="section">
<div class="section">
<h4><a name="Prerequisites"></a>Prerequisites</h4>
<p>As well as having JRuby installed, for the EHRI/Ruby environment to work you need a couple of env vars set:</p>

<ul>
  
<li><tt>$NEO4J_HOME</tt></li>
  
<li><tt>$CLASSPATH</tt></li>
</ul>
<p>As usual, <tt>$NEO4J_HOME</tt> should point to a version of Neo4j with the EHRI plugin installed. The <tt>$CLASSPATH</tt> var can be exported like so:</p>

<div class="source">
<div class="source">
<pre>source ./scripts/lib.sh      # Source the EHRI bash tools
buildclasspath               # This function builds a Java-ish string of dependencies from the $NEO4J_HOME
export CLASSPATH=$CLASSPATH  # Exports the CLASSPATH var created by buildclasspath
</pre></div></div></div>
<div class="section">
<h4><a name="Using_the_Ehri_module"></a>Using the &#x2018;Ehri&#x2019; module</h4>
<p>Much of the heavy lifting of setting up the EHRI environment has been placed in a module called <tt>Ehri</tt> inside the <tt>scripts/ruby/lib</tt> directory of the EHRI Neo4j server code root. You can pull this into your Ruby script environment like so:</p>

<div class="source">
<div class="source">
<pre>require &quot;scripts/lib/ehri&quot;
include Ehri
</pre></div></div>
<p>The <tt>Ehri</tt> module does the following when <tt>required</tt>:</p>

<ul>
  
<li>Checks the <tt>$NEO4J_HOME</tt> and <tt>$CLASSPATH</tt> env vars look okay</li>
  
<li><tt>java_import</tt>s some key useful stuff, like the Tinkerpop Neo4jGraph and FramedGraph</li>
  
<li>Creates some Ruby modules as shortcuts through which EHRI packages can be accessed</li>
  
<li>Initialises the graph database and an EHRI GraphManager as the constants <tt>Graph</tt> and <tt>Manager</tt> (subject to change)</li>
</ul>
<p>The shortcut modules within <tt>Ehri</tt> are:</p>

<ul>
  
<li><tt>Core</tt> - eu.ehri.project.core</li>
  
<li><tt>Models</tt> - eu.ehri.project.models</li>
  
<li><tt>Persistance</tt> - eu.ehri.project.persistance</li>
  
<li><tt>Importers</tt> - eu.ehri.project.importers</li>
  
<li><tt>Acl</tt> - eu.ehri.project.acl</li>
</ul>
<p>Putting all this together, you can then do stuff like this from the REPL:</p>

<div class="source">
<div class="source">
<pre>03:24 PM &gt; jirb
irb(main):001:0&gt; require &quot;scripts/ruby/lib/ehri&quot;
=&gt; true
irb(main):002:0&gt; include Ehri
=&gt; Object
irb(main):003:0&gt; mike = Manager.get_frame(&quot;mike&quot;, Models::UserProfile.java_class)
=&gt; #&lt;Java::Default::$Proxy30:0x5820e5f8&gt;
irb(main):004:0&gt; mike.name
=&gt; &quot;Mike Bryant&quot;
irb(main):005:0&gt;
</pre></div></div>
<p>For example, a script to list the names of all repositories in the United Kingdom:</p>

<div class="source">
<div class="source">
<pre>require &quot;scripts/ruby/lib/ehri&quot;

include Ehri

gb = Manager.get_frame(&quot;gb&quot;, Models::Country.java_class)
gb.get_repositories.each { |repository|
  puts &quot; - #{repository.get_descriptions.first.name}&quot;
}

# This prints:
# - Department of Documents, Imperial War Museum
# - Archiwum Studium Polski Podziemnej
# - MOVIETONE
# - Manchester Jewish Museum
# - Jewish Museum London
# - British Library
# - University of Southampton
# - Oxford Centre for Hebrew and Jewish Studies
# - The National Archives
# - London Metropolitan Archives
# - Imperial War Museums
# - Island Archives
# - British Path&#xe9;News
# - Polish Institute and Sikorski Museum
# - Central British Fund
# - Jersey Archive
# - Department for Business Innovation and Skills, &quot;Enemy Property&quot;
# - Association of Jewish Refugees, Serving Holocaust Refugees and Survivors Nationwide
# - The Wiener Library for the Study of the Holocaust&amp;Genocide

</pre></div></div>
<p>Lots of other useful things are possible. For more examples, look at some of the import tools in <tt>scripts/ruby/lib</tt>. These are themselves modules that extent the <tt>Ehri</tt> module, for example:</p>

<div class="source">
<div class="source">
<pre># Require the Ehri module, which we know is alongside our current one in the lib dir
require &quot;#{File.dirname(__FILE__)}/ehri&quot;

module Ehri
  module MyImporter

    class Importer
      def initialize(directory)
        @dir = directory
      end

      def import
        # do lots of stuff with `Graph` and `Manager` etc
      end
    end

    # Entry point function
    def self.import(directory)
      Importer.new(directory).import
    end
  end
end
</pre></div></div>
<p>From another script, this can then be launched like so:</p>

<div class="source">
<div class="source">
<pre>require &quot;scripts/ruby/lib/myimporter&quot;

DIRECTORY = ARGV.shift # get the dir from a argument
Ehri::MyImporter::import(DIRECTORY)
</pre></div></div>
<p>In the EHRI Neo4j server dev system we have some existing management commands, for doing things like initialising the  graph and importing files. There can be run directly (although perhaps not in the nicest manner) like so:</p>

<div class="source">
<div class="source">
<pre># Runs the 'Initialize' command, with an empty set of arguments
# as if they were provided via the command-line...
#
# Note the the [].to_java(:string) bit is how a Java String[] is
# constructed in JRuby...

Commands::Initialize.new.exec(Graph, [].to_java(:string))
</pre></div></div>
<p>Note that the <tt>Graph</tt> constant (which is a <tt>FramedGraph&lt;Neo4jGraph&gt;</tt> initialised when <tt>require</tt>ing the <tt>Ehri</tt> module) is the first argument.</p>
<p>Another, more complex example, is running the LoadFixtures command, with an argument that gives the YAML fixture file  to load:</p>

<div class="source">
<div class="source">
<pre>Commands::LoadFixtures.new.exec(Graph, [&quot;#{ENV[&quot;HOME&quot;]}/Dropbox/EHRI/users.yaml&quot;].to_java(:string))
</pre></div></div></div></div>
<div class="section">
<h3><a name="Gotchas:"></a>Gotchas:</h3>
<p>For the (rare) Java method that requires passing a <tt>char</tt>, I cannot find a less ugly way to do this than:</p>

<div class="source">
<div class="source">
<pre># Take a Ruby string, slice the first item, convert it to an Ord, and then a java char...
csv = CSVReader.new(fio, &quot;;&quot;[0].ord.to_java(:char)) # Yuck!
</pre></div></div>
<p>More documentation to follow&#x2026;</p></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                              <p >Copyright &copy;                    2014
                        <a href="http://ehri-project.eu">The European Holocaust Research Infrastructure (EHRI)</a>.
            All rights reserved.      
                    
      </p>
        </div>

        
        
                </div>
    </footer>
        </body>
</html>
